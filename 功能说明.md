# 课堂测试系统 - 学生测试内容选择功能说明

## 功能概述

在学生测试页面的班级号与开始测试按钮之间增加了一个测试内容选择下拉框，其内容与教师面板预设内容一致。当教师面板勾选了"允许学生自选测试内容"时，学生可以选择预设的测试内容；未勾选时，默认选择教师面板最后保存的测试内容。

## 功能特性

### 1. 智能显示控制
- **允许自选时**：显示测试内容选择下拉框，学生可以从预设列表中选择
- **不允许自选时**：隐藏测试内容选择下拉框，自动使用教师最后保存的测试配置

### 2. 测试内容来源
- **学生选择预设**：使用选定的TestPreset配置进行测试
- **学生未选择**：使用当前激活的Test配置进行测试

### 3. 动态配置加载
- 页面加载时自动检查教师设置
- 根据设置动态加载相应的测试预设列表
- 实时响应教师设置的变更

## 技术实现

### 前端修改

#### 文件：`templates/student_start.html`
- 在班级号输入框和开始测试按钮之间添加测试内容选择下拉框
- 添加JavaScript逻辑检查教师设置
- 动态加载测试预设列表
- 根据设置控制下拉框的显示/隐藏

```html
<div class="mb-3" id="testContentDiv" style="display: none;">
    <label for="test_content" class="form-label">测试内容</label>
    <select class="form-select" id="test_content" name="test_content">
        <option value="">-- 请选择测试内容 --</option>
    </select>
</div>
```

### 后端修改

#### 文件：`app.py`

##### 新增API端点
1. **`/api/current_test_settings`** - 获取当前测试设置（公开访问）
   - 返回是否允许学生自选测试内容
   - 学生页面可访问，无需登录

2. **`/api/test_presets_public`** - 公开获取测试预设列表
   - 返回所有可用的测试预设
   - 学生页面可访问，无需登录

##### 修改的路由函数
1. **`student_start()`** - 学生开始测试
   - 获取学生选择的测试内容
   - 将选择的预设ID存储到session中

2. **`test()`** - 测试页面
   - 根据学生选择决定使用预设配置还是默认测试
   - 动态生成测试内容

3. **`submit_test()`** - 提交测试
   - 根据学生选择使用相应的评分配置
   - 正确处理预设和默认测试的test_id

## 数据流程

### 1. 页面加载流程
```
学生访问开始测试页面
    ↓
检查教师设置（/api/current_test_settings）
    ↓
如果允许自选 → 显示下拉框并加载预设列表
如果不允许自选 → 隐藏下拉框
```

### 2. 测试生成流程
```
学生提交表单
    ↓
检查是否选择了预设
    ↓
选择预设 → 使用TestPreset配置生成测试
未选择 → 使用当前Test配置生成测试
    ↓
根据配置抽题并显示测试
```

### 3. 测试提交流程
```
学生提交测试答案
    ↓
根据选择的配置进行评分
    ↓
保存测试结果（test_id根据选择设置）
```

## 数据库影响

### 新增字段
- `TestPreset.allow_student_choice` - 是否允许学生自选测试内容

### 数据关系
- 学生可以选择任意TestPreset进行测试
- 测试结果中的test_id字段：
  - 使用预设时：test_id = None
  - 使用默认测试时：test_id = 当前测试ID

## 使用说明

### 教师端
1. 在教师控制面板中设置测试参数
2. 勾选"允许学生自选测试内容"选项
3. 保存设置

### 学生端
1. 访问学生开始测试页面
2. 填写姓名和班级号
3. 如果教师允许自选，从下拉框中选择测试内容
4. 点击"开始测试"进入测试

## 注意事项

1. **权限控制**：新增的API端点为公开访问，无需登录验证
2. **数据一致性**：确保TestPreset和Test模型的数据结构一致
3. **错误处理**：当选择的预设不存在时，会重定向到开始页面并显示错误信息
4. **性能考虑**：预设列表在页面加载时一次性获取，避免重复请求

## 测试建议

1. 测试教师勾选/取消勾选"允许学生自选测试内容"选项
2. 测试学生选择不同预设的测试内容
3. 测试学生不选择预设时的默认行为
4. 验证测试结果的正确性和完整性
5. 检查各种边界情况和错误处理

## 扩展可能

1. **预设分类**：可以按难度、主题等对预设进行分类
2. **预设预览**：显示预设的题目数量和分值信息
3. **历史记录**：记录学生使用过的预设，便于分析
4. **批量操作**：允许教师批量设置多个预设的可用性 