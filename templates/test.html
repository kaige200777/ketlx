<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课堂练习评估系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">课堂练习评估系统</a>
            <div class="navbar-text text-light">
                学生：{{ session.student_name }} | 班级：{{ session.class_number }}
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h3 class="text-center">{{ test_title }}</h3>
            </div>
            <div class="card-body">
                <form action="{{ url_for('submit_test') }}" method="post">
                    {% if single_choice_questions %}
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">单选题（每题{{ test.single_choice_score }}分）</h5>
                        </div>
                        <div class="card-body">
                            {% for question in single_choice_questions %}
                            <div class="card mb-3">
                                <div class="card-header">
                                    第{{ loop.index }}题
                                </div>
                                <div class="card-body">
                                    <p class="fw-bold" style="white-space: pre-wrap;">{{ question.content|replace('\n', '<br>')|safe }}</p>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="answer_{{ question.id }}" id="a{{ question.id }}" value="A">
                                        <label class="form-check-label" for="a{{ question.id }}">A. {{ question.option_a }}</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="answer_{{ question.id }}" id="b{{ question.id }}" value="B">
                                        <label class="form-check-label" for="b{{ question.id }}">B. {{ question.option_b }}</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="answer_{{ question.id }}" id="c{{ question.id }}" value="C">
                                        <label class="form-check-label" for="c{{ question.id }}">C. {{ question.option_c }}</label>
                                    </div>
                        <div class="form-check">
                                        <input class="form-check-input" type="radio" name="answer_{{ question.id }}" id="d{{ question.id }}" value="D">
                                        <label class="form-check-label" for="d{{ question.id }}">D. {{ question.option_d }}</label>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if multiple_choice_questions %}
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">多选题（每题{{ test.multiple_choice_score }}分）</h5>
                        </div>
                        <div class="card-body">
                            {% for question in multiple_choice_questions %}
                            <div class="card mb-3">
                                <div class="card-header">
                                    第{{ loop.index }}题
                                </div>
                                <div class="card-body">
                                    <p class="fw-bold" style="white-space: pre-wrap;">{{ question.content|replace('\n', '<br>')|safe }}</p>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="answer_{{ question.id }}" id="a{{ question.id }}" value="A">
                                        <label class="form-check-label" for="a{{ question.id }}">A. {{ question.option_a }}</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="answer_{{ question.id }}" id="b{{ question.id }}" value="B">
                                        <label class="form-check-label" for="b{{ question.id }}">B. {{ question.option_b }}</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="answer_{{ question.id }}" id="c{{ question.id }}" value="C">
                                        <label class="form-check-label" for="c{{ question.id }}">C. {{ question.option_c }}</label>
                        </div>
                        <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="answer_{{ question.id }}" id="d{{ question.id }}" value="D">
                                        <label class="form-check-label" for="d{{ question.id }}">D. {{ question.option_d }}</label>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if true_false_questions %}
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">判断题（每题{{ test.true_false_score }}分）</h5>
                        </div>
                        <div class="card-body">
                            {% for question in true_false_questions %}
                            <div class="card mb-3">
                                <div class="card-header">
                                    第{{ loop.index }}题
                                </div>
                                <div class="card-body">
                                    <p class="fw-bold" style="white-space: pre-wrap;">{{ question.content|replace('\n', '<br>')|safe }}</p>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="answer_{{ question.id }}" id="true{{ question.id }}" value="正确">
                                        <label class="form-check-label" for="true{{ question.id }}">正确</label>
                        </div>
                        <div class="form-check">
                                        <input class="form-check-input" type="radio" name="answer_{{ question.id }}" id="false{{ question.id }}" value="错误">
                                        <label class="form-check-label" for="false{{ question.id }}">错误</label>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if fill_blank_questions %}
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">填空题（每题{{ test.fill_blank_score }}分）</h5>
                        </div>
                        <div class="card-body">
                            {% for question in fill_blank_questions %}
                            <div class="card mb-3">
                                <div class="card-header">
                                    第{{ loop.index }}题
                                </div>
                                <div class="card-body">
                                    <p class="fw-bold" style="white-space: pre-wrap;">{{ question.content|replace('\n', '<br>')|safe }}</p>
                                    <div class="form-group">
                                        <div class="row g-2">
                                            {% for i in range(1, 5) %}
                                            <div class="col">
                                                <input type="text" class="form-control" name="answer_{{ question.id }}_{{ i }}" placeholder="填空{{ i }}">
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if short_answer_questions %}
                    <div class="card mb-4">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">简答题（每题{{ test.short_answer_score }}分）</h5>
                        </div>
                        <div class="card-body">
                            {% for question in short_answer_questions %}
                            <div class="card mb-3">
                                <div class="card-header">
                                    第{{ loop.index }}题
                                </div>
                                <div class="card-body">
                                    <p class="fw-bold" style="white-space: pre-wrap;">{{ question.content|replace('\n', '<br>')|safe }}</p>
                                    <div class="form-group">
                                        <textarea class="form-control allow-img-paste" name="answer_{{ question.id }}" rows="4" placeholder="请输入答案（可粘贴图片）"></textarea>
                                    </div>
                        </div>
                    </div>
                    {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-primary btn-lg" onclick="checkUnanswered()">提交答案</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/paste_image.js') }}"></script>
    <script>
    function checkUnanswered() {
        var unanswered = [];
        var qIndex = 1;
        // 单选、多选、判断、填空、简答
        document.querySelectorAll('input[type="radio"]').forEach(function(radio) {
            if (radio.name && !unanswered.includes(radio.name)) {
                var checked = document.querySelector('input[name="' + radio.name + '"]:checked');
                if (!checked) {
                    unanswered.push(radio.name);
                }
            }
        });
        document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
            if (checkbox.name && !unanswered.includes(checkbox.name)) {
                var checked = document.querySelectorAll('input[name="' + checkbox.name + '"]:checked');
                if (checked.length === 0) {
                    unanswered.push(checkbox.name);
                }
            }
        });
        // 处理填空题：同一题 id 有多个输入，任意一空填写即可视为已答
        var fillGroups = {};
        document.querySelectorAll('input[type="text"]').forEach(function(input) {
            if(!input.name) return;
            var parts = input.name.split('_');
            if(parts.length===3){ // 填空题 answer_{id}_{idx}
                var qid = parts[1];
                if(!fillGroups[qid]) fillGroups[qid] = false;
                if(input.value.trim() !== '') fillGroups[qid] = true;
            }else{
                // 非填空题文本（如简答题）
                if(input.value.trim() === '') unanswered.push(input.name);
            }
        });
        Object.keys(fillGroups).forEach(function(qid){
            if(!fillGroups[qid]){
                unanswered.push('answer_'+qid+'_1'); // 占位，用于后续提取题号
            }
        });
        document.querySelectorAll('textarea').forEach(function(input) {
            if (input.name && input.value.trim() === '') {
                unanswered.push(input.name);
            }
        });
        if (unanswered.length > 0) {
            // 提取题号
            var ids = unanswered.map(function(name) {
                var id = name.split('_')[1];
                var card = document.querySelector('[name="' + name + '"]').closest('.card');
                var header = card ? card.querySelector('.card-header') : null;
                var num = header ? header.textContent.replace(/[^\d]/g, '') : id;
                return num;
            });
            var msg = '您还有以下题目未作答：' + ids.join('、') + '\n是否继续提交？';
            if (confirm(msg)) {
                document.querySelector('form').submit();
            }
        } else {
            document.querySelector('form').submit();
        }
    }
    </script>
</body>
</html> 